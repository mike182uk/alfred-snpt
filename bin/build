#!/usr/bin/env bash

MODULE_DIR=`npm config get prefix`/lib/node_modules/snpt-alfred-workflow

echo "Checking dependencies..."

NODE_BIN=`which node`
FZF_BIN=`which fzf`
SNPT_BIN=`which snpt`

if [ -z "$NODE_BIN" ]; then
  echo "node was not found" && exit 1
fi

if [ -z "$FZF_BIN" ]; then
  echo "fzf was not found" && exit 1
fi

if [ -z "$SNPT_BIN" ]; then
  echo "snpt was not found" && exit 1
fi

echo "Copying files..."

BUILD_DIR=`mktemp -d`
cp ${MODULE_DIR}/src/* ${BUILD_DIR}
mkdir ${BUILD_DIR}/node_modules
cp -r ${MODULE_DIR}/node_modules/get-stdin ${BUILD_DIR}/node_modules/get-stdin

echo "Updating workflow scripts..."

sed -i '' 's|{node_bin}|'${NODE_BIN}'|g' "$BUILD_DIR/info.plist"
sed -i '' 's|{fzf_bin}|'${FZF_BIN}'|g' "$BUILD_DIR/info.plist"
sed -i '' 's|{snpt_bin}|'${SNPT_BIN}'|g' "$BUILD_DIR/info.plist"

echo "Building workflow..."

CURRENT_DIR=`pwd`
rm -rf Snpt.alfredworkflow
cd ${BUILD_DIR} && zip -rq "$CURRENT_DIR/Snpt.alfredworkflow" *

echo "Cleaning up..."

rm -rf ${BUILD_DIR}

echo "Done!"
